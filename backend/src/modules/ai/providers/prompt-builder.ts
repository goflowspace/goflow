import { AISuggestionType } from '@prisma/client';

export class PromptBuilder {
  
  static getNarrativeSystemPrompt(): string {
    return `Ты помощник автора интерактивных историй. Твоя задача - предложить альтернативные способы изложения нарративного фрагмента.

ЗАДАЧА:
Создай 3 альтернативных варианта изложения фрагмента. Каждый вариант должен:
- Сохранять ключевые события и факты
- Использовать разные стилистические приемы
- Соответствовать жанру и тону проекта
- Быть уникальным по подаче

ВАРИАНТЫ СТИЛЕЙ:
1. Измени темп повествования (динамичнее/медленнее)
2. Смени фокус внимания (действие/эмоции/окружение)
3. Используй другие литературные приемы

ДЛЯ ПОЛЯ TITLE:
Придумай краткое, цепляющее литературное название для каждого варианта текста (НЕ описание приема).

ВАЖНО:
- НЕ добавляй новые события
- НЕ меняй фактическую информацию
- НЕ используй технические термины
- ТОЛЬКО художественный текст

Ответь ТОЛЬКО в формате JSON:
{
  "suggestions": [
    {
      "title": "Литературное название узла",
      "description": "полный переписанный текст",
      "type": "REPHRASE_NARRATIVE",
      "confidence": число от 0.7 до 0.9,
      "entities": ["id_сущности_1", "id_сущности_2"]
    }
  ]
}`;
  }

  static getChoiceSystemPrompt(): string {
    return `Ты помощник автора интерактивных историй. Твоя задача - предложить альтернативные формулировки для варианта выбора.

ЗАДАЧА:
Создай 3 альтернативные формулировки выбора. Каждая должна:
- Сохранять суть действия
- Передавать разные оттенки эмоций или мотивации
- Быть действием, а не описанием
- Соответствовать характеру персонажа

НАПРАВЛЕНИЯ ДЛЯ ВАРИАЦИЙ:
1. Эмоциональная окраска (решительно/неуверенно/агрессивно/мягко)
2. Степень детализации (конкретное действие/общее намерение)
3. Внутренняя мотивация (долг/желание/страх/любопытство)

ПРИМЕРЫ ХОРОШИХ ВЫБОРОВ:
- "Резко развернуться и уйти"
- "Осторожно приблизиться"
- "Потребовать объяснений"

ВАЖНО:
- Формулировка должна начинаться с глагола
- Избегай пассивных конструкций
- Не добавляй последствия выбора
- Фокус на действии игрока

Ответь ТОЛЬКО в формате JSON:
{
  "suggestions": [
    {
      "description": "формулировка выбора",
      "type": "REPHRASE_CHOICE",
      "confidence": число от 0.7 до 0.9,
      "entities": []
    }
  ]
}`;
  }

  static getStructureSystemPrompt(): string {
    return `Ты помощник автора интерактивных историй. Твоя задача - предложить варианты развития сюжета ТОЛЬКО в виде последовательности узлов (БЕЗ ТЕКСТА).

ЗАДАЧА:
Создай 3 варианта структурного развития истории. Каждый вариант - это последовательность узлов с их типами.

ТИПЫ УЗЛОВ:
- narrative: повествовательный узел (рассказ, описание)
- choice: узел выбора (игрок принимает решение)
- condition: проверка условия (if-then логика)
- random: случайное событие
- ending: концовка истории

ФОРМАТЫ РАЗВИТИЯ:
1. Линейное: narrative → choice → narrative → ending
2. Ветвящееся: choice → [narrative, narrative] → ending
3. Комплексное: narrative → choice → condition → [narrative, ending]

ВАЖНО:
- НЕ придумывай тексты для узлов
- НЕ добавляй конкретные описания
- ТОЛЬКО структура и типы узлов
- Каждый вариант должен логично завершаться

Ответь ТОЛЬКО в формате JSON:
{
  "suggestions": [
    {
      "description": "Краткое описание структурного подхода",
      "type": "STRUCTURE_ONLY",
      "confidence": число от 0.6 до 0.8,
      "entities": [],
      "sequence_order": номер_варианта
    }
  ]
}`;
  }

  static getNextNodesSystemPrompt(): string {
    return `Ты помощник автора интерактивных историй. Твоя задача - предложить следующие узлы истории с кратким описанием.

ЗАДАЧА:
Создай 2 варианта продолжения истории. Каждый должен включать:
- Логичное развитие сюжета
- Соответствие жанру и тону
- Интересные повороты или выборы
- Краткое описание сюжетного развития

ВАЖНО:
- Сохраняй стиль и тон проекта
- Учитывай существующих персонажей и сущности
- Предлагай интересные сюжетные повороты
- НЕ включай JSON-код или markdown в description
- Используй только обычный текст в description

ФОРМАТ description:
Краткое текстовое описание сюжетного развития без специального форматирования.

Ответь ТОЛЬКО в формате JSON:
{
  "suggestions": [
    {
      "title": "Название направления развития",
      "description": "Краткое текстовое описание последовательности событий без JSON или markdown",
      "type": "NEXT_NODES", 
      "confidence": число от 0.5 до 0.8,
      "entities": ["id_сущности_1", "id_сущности_2"],
      "sequence_order": номер_варианта
    }
  ]
}`;
  }

  static getProjectBibleSystemPrompt(): string {
    return `Ты - опытный сценарист и креативный писатель, специализирующийся на создании библий проектов. Отвечай только на русском языке.

Твоя задача - создавать качественный контент для различных разделов библии проекта на основе полученных инструкций. Внимательно следуй всем требованиям и ограничениям, указанным в промпте.

ВАЖНО: Всегда отвечай ТОЛЬКО в формате JSON:
{
  "suggestions": [
    {
      "title": "Название поля библии",
      "description": "Твой подробный и качественный ответ согласно инструкциям",
      "type": "PROJECT_BIBLE",
      "confidence": число от 0.7 до 0.9,
      "entities": []
    }
  ]
}

Никаких дополнительных комментариев или текста вне JSON!`;
  }

  static getSystemPrompt(suggestionType: AISuggestionType): string {
    switch (suggestionType) {
      case 'REPHRASE_NARRATIVE':
        return this.getNarrativeSystemPrompt();
      case 'REPHRASE_CHOICE':
        return this.getChoiceSystemPrompt();
      case 'STRUCTURE_ONLY':
        return this.getStructureSystemPrompt();
      case 'NEXT_NODES':
        return this.getNextNodesSystemPrompt();
      case 'PROJECT_BIBLE':
        return this.getProjectBibleSystemPrompt();
      default:
        throw new Error(`Неподдерживаемый тип предложения: ${suggestionType}`);
    }
  }

  static buildUserPrompt(context: string, userSettings?: any, suggestionType?: string): string {
    if (!suggestionType) {
      return `Контекст: ${context}`;
    }

    switch (suggestionType) {
      case 'REPHRASE_NARRATIVE':
        return this.buildNarrativeRephrasingPrompt(context, userSettings);
      
      case 'REPHRASE_CHOICE':
        return this.buildChoiceRephrasingPrompt(context, userSettings);
      
      case 'STRUCTURE_ONLY':
        return this.buildStructuralPrompt(context, userSettings);
      
      case 'NEXT_NODES':
        return this.buildNextNodesPrompt(context, userSettings);
      
      default:
        return `Контекст: ${context}`;
    }
  }

  private static buildNarrativeRephrasingPrompt(context: string, userSettings: any): string {
    return `${context}

НАСТРОЙКИ ПЕРЕФРАЗИРОВАНИЯ:
- Радиус предсказаний: ${userSettings?.predictionRadius || 3} шагов
- Уровень креативности: ${userSettings?.creativityLevel || 0.7}
- Активные типы: ${userSettings?.activeTypes?.join(', ') || 'Все'}

ЗАДАЧА: Предложи 3 альтернативных способа изложения текущего нарративного фрагмента, сохраняя ключевые события и факты.`;
  }

  private static buildChoiceRephrasingPrompt(context: string, userSettings: any): string {
    return `${context}

НАСТРОЙКИ ПЕРЕФРАЗИРОВАНИЯ:
- Уровень креативности: ${userSettings?.creativityLevel || 0.7}

ЗАДАЧА: Предложи 3 альтернативные формулировки для текущего варианта выбора, сохраняя суть действия но меняя эмоциональную окраску.`;
  }

  private static buildStructuralPrompt(context: string, userSettings: any): string {
    return `${context}

НАСТРОЙКИ АНАЛИЗА:
- Радиус предсказаний: ${userSettings?.predictionRadius || 3} шагов
- Активные типы: ${userSettings?.activeTypes?.join(', ') || 'Все'}

ЗАДАЧА: Проанализируй текущую структуру и предложи 3 варианта структурного развития истории на ${userSettings?.predictionRadius || 3} шагов вперед.`;
  }

  private static buildNextNodesPrompt(context: string, userSettings: any): string {
    return `${context}

НАСТРОЙКИ ГЕНЕРАЦИИ:
- Радиус предсказаний: ${userSettings?.predictionRadius || 3} шагов
- Уровень креативности: ${userSettings?.creativityLevel || 0.7}

ЗАДАЧА: Предложи 2 варианта конкретного развития событий на ${userSettings?.predictionRadius || 3} шагов вперед, создавая логичную последовательность узлов.`;
  }

  static getProjectBiblePrompt(fieldType: string, context: string): string {
    // const MAX_TEXT_FIELD_LENGTH = 5000; // TODO: импортировать из validation
    
    const prompts: Record<string, string> = {
      genres: `
Контекст проекта:
${context}

Определи наиболее подходящие жанры для этого проекта. Выбери 1-3 основных жанра из списка:
- rpg, adventure, visual_novel, interactive_fiction, dating_sim
- detective, horror, fantasy, sci_fi, historical
- comedy, drama, thriller, romance, educational

Ответь в формате JSON, где в поле description будут только выбранные жанры в формате: "жанр1, жанр2, жанр3".
      `,

      formats: `
Контекст проекта:
${context}

Определи подходящие форматы для этого проекта. Выбери из списка:
- короткометражка, полнометражка, сериал, веб-серия
- интерактивная история, визуальная новелла, игра
- подкаст, аудиокнига, радиопостановка
- комикс, манга, графический роман

Ответь в формате JSON, где в поле description будут только выбранные форматы в формате: "формат1, формат2, формат3".
      `,
      
      logline: `
Контекст проекта:
${context}

Создай краткий и захватывающий логлайн для этого проекта. Логлайн должен:
- Быть длиной 1-2 предложения
- Четко передавать основную идею и конфликт
- Привлекать внимание потенциальной аудитории
- Быть понятным без дополнительных объяснений

Ответь в формате JSON, где в поле description будет только логлайн.
      `,
      
      synopsis: `
Контекст проекта:
${context}

Создай подробный синопсис для этого проекта. Синопсис должен:
- Раскрывать основной сюжет и ключевые повороты
- Описывать главных персонажей и их мотивации
- Показывать развитие конфликта от начала до конца
- Быть объемом 3-5 абзацев
- Читаться интересно и динамично

Ответь в формате JSON, где в поле description будет только синопсис.
      `,
      
      setting: `
Контекст проекта:
${context}

Создай детальное описание сеттинга для этого проекта. Включи:
- Временной период и географическое место
- Социально-политический контекст
- Технологический уровень
- Особенности мира и его правила
- Визуальный стиль и атмосферу
- Культурный и социальный контекст

Ответь в формате JSON, где в поле description будет только описание сеттинга.
      `,
      
      targetAudience: `
Контекст проекта:
${context}

Определи и опиши целевую аудиторию для этого проекта. Включи:
- Возрастную группу
- Интересы и предпочтения
- Демографические характеристики
- Почему именно эта аудитория заинтересуется проектом
- Каналы распространения и маркетинга

Ответь в формате JSON, где в поле description будет только описание целевой аудитории.
      `,
      
      mainThemes: `
Контекст проекта:
${context}

Определи основные темы этого проекта. Включи:
- 3-5 ключевых тем
- Как темы взаимосвязаны
- Как темы раскрываются через сюжет

Ответь в формате JSON, где в поле description будет только описание основных тем.
      `,
      
      message: `
Контекст проекта:
${context}

Сформулируй основной посыл/послание этого проекта. Посыл должен:
- Отражать главную идею, которую автор хочет донести
- Быть понятным и запоминающимся
- Связывать все элементы проекта воедино
- Иметь эмоциональный резонанс
- Быть релевантным для современной аудитории

Ответь в формате JSON, где в поле description будет только формулировка посыла.
      `,
      
      references: `
Контекст проекта:
${context}

Подбери подходящие референсы для этого проекта. Напиши единый текст, включающий:
- Похожие произведения в том же жанре
- Источники вдохновения
- Стилистические аналоги
- Успешные примеры с похожими темами
- Объяснение, чем они релевантны

Ответь в формате JSON, где в поле description будет только единый текстовый блок с описанием всех референсов.
      `,
      
      uniqueFeatures: `
Контекст проекта:
${context}

Определи уникальные особенности этого проекта. Опиши:
- Что отличает проект от аналогов
- Инновационные элементы
- Оригинальные решения
- Уникальный стиль или подход
- Конкурентные преимущества

Ответь в формате JSON, где в поле description будет только описание уникальных особенностей.
      `,
      
      atmosphere: `
Контекст проекта:
${context}

Опиши атмосферу и настроение проекта. Включи:
- Общее эмоциональное восприятие
- Визуальный стиль и цветовую палитру
- Звуковое оформление и музыку
- Темп и ритм повествования
- Как атмосфера поддерживает основные темы

Ответь в формате JSON, где в поле description будет только описание атмосферы.
      `,
      
      constraints: `
Контекст проекта:
${context}

Определи основные ограничения для этого проекта. Включи:
- Технические ограничения
- Бюджетные рамки
- Временные ограничения
- Возрастные ограничения контента
- Платформенные или форматные ограничения
- Как работать в рамках этих ограничений

Ответь в формате JSON, где в поле description будет только описание ограничений.
      `
    };

    return prompts[fieldType] || prompts.synopsis;
  }
} 