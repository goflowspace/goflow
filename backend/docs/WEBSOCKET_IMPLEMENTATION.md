# ‚úÖ WebSocket –ö–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—è - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

## üéØ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º SOLID**

‚úÖ **Single Responsibility Principle**
- `WebSocketManager` - —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏  
- `CollaborationService` - —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–∏ –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏
- `EventHandlers` - —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
- `WebSocketController` - —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è

‚úÖ **Open/Closed Principle**  
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ `EventHandler` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ `Map<EventType, Handler>`

‚úÖ **Liskov Substitution Principle**
- –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç `BaseEventHandler`
- –í–∑–∞–∏–º–æ–∑–∞–º–µ–Ω—è–µ–º—ã —á–µ—Ä–µ–∑ –æ–±—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

‚úÖ **Interface Segregation Principle**
- –ú–∞–ª–µ–Ω—å–∫–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- –ö–ª–∏–µ–Ω—Ç—ã –∑–∞–≤–∏—Å—è—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –Ω—É–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤

‚úÖ **Dependency Inversion Principle**
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π (`EventHandler`)
- –ù–µ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π

### 2. **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã**

#### **Core Components**
```
src/
‚îú‚îÄ‚îÄ types/websocket.types.ts           # –¢–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îú‚îÄ‚îÄ modules/websocket/
‚îÇ   ‚îú‚îÄ‚îÄ websocket.manager.ts           # –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ collaboration.service.ts       # –°–µ—Ä–≤–∏—Å –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ websocket.controller.ts        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ websocket.routes.ts            # REST API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ event-handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.handler.ts            # –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ awareness.handler.ts       # Cursor, Selection
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ operation.handler.ts       # –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ README.md                      # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

#### **–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π**
```typescript
enum CollaborationEventType {
  OPERATION_BROADCAST = 'OPERATION_BROADCAST',  // –û–ø–µ—Ä–∞—Ü–∏–∏
  CURSOR_MOVE = 'CURSOR_MOVE',                  // –ö—É—Ä—Å–æ—Ä
  SELECTION_CHANGE = 'SELECTION_CHANGE',        // –í—ã–¥–µ–ª–µ–Ω–∏–µ
  USER_JOIN = 'USER_JOIN',                      // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  USER_LEAVE = 'USER_LEAVE',                    // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
  AWARENESS_UPDATE = 'AWARENESS_UPDATE',        // Awareness
  CONNECTION_ESTABLISHED = 'CONNECTION_ESTABLISHED',
  ERROR = 'ERROR'
}
```

### 3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π**

‚úÖ **SyncService Integration**
- `OperationEventHandler` –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º `SyncService`
- –û–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—Ç—Å—è –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

‚úÖ **Authentication**
- JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ middleware
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

‚úÖ **REST API**
- Endpoints –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏

### 4. **–ü—Ä–∏–Ω—Ü–∏–ø—ã DRY –∏ KISS**

‚úÖ **DRY (Don't Repeat Yourself)**
- `BaseEventHandler` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â—É—é –ª–æ–≥–∏–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- Singleton –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
- –û–±—â–∏–µ —Ç–∏–ø—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ

‚úÖ **KISS (Keep It Simple, Stupid)**
- –ü—Ä–æ—Å—Ç–∞—è –∏ –ø–æ–Ω—è—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

## üöÄ API –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### **WebSocket Events**

#### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø—Ä–æ–µ–∫—Ç—É
```javascript
socket.emit('join_project', { projectId: 'project-123' });
```

#### Awareness —Å–æ–±—ã—Ç–∏—è
```javascript
socket.emit('CURSOR_MOVE', {
  type: 'CURSOR_MOVE',
  payload: { cursor: { x: 100, y: 200, timelineId: 'timeline-1', layerId: 'layer-1' } },
  userId: 'user-123',
  projectId: 'project-123',
  timestamp: Date.now()
});
```

#### –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```javascript
socket.emit('OPERATION_BROADCAST', {
  type: 'OPERATION_BROADCAST',
  payload: { operation: { /* –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ */ } },
  userId: 'user-123',
  projectId: 'project-123',
  timestamp: Date.now()
});
```

### **REST API**

#### –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
```http
GET /ws/projects/:projectId/participants
Authorization: Bearer <jwt-token>
```

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```http
GET /ws/stats
Authorization: Bearer <jwt-token>  
```

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ server.ts

```typescript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
const wsManager = WebSocketManager.getInstance();
wsManager.initialize(server);

const wsController = new WebSocketController();
wsController.setupConnectionHandlers();
```

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
npm install socket.io @types/socket.io nanoid
```

## üéõÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **CORS Settings**
```typescript
cors: {
  origin: process.env.FRONTEND_URL || "http://localhost:3000",
  methods: ["GET", "POST"],
  credentials: true
}
```

### **Transports**
```typescript
transports: ['websocket', 'polling']
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞**
   - JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ WebSocketManager
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π

2. **–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ø—Ä–æ–µ–∫—Ç—É**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (TODO)
   - –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏
   - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π**
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è
   - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

4. **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ**
   - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

## üßπ –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- Graceful shutdown –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å–µ—Å—Å–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

## üé® –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è:

1. **–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –≤ enum**
2. **–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫**
3. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ**

```typescript
// 1. –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø
enum CollaborationEventType {
  NEW_EVENT = 'NEW_EVENT'
}

// 2. –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫  
class NewEventHandler extends BaseEventHandler {
  async handle(socket: Socket, event: CollaborationEvent) {
    // –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  }
}

// 3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
this.eventHandlers.set(CollaborationEventType.NEW_EVENT, new NewEventHandler());
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

- –í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Winston
- Debug —Ä–µ–∂–∏–º –¥–ª—è Socket.IO
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è:
- Real-time –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏
- Awareness (–∫—É—Ä—Å–æ—Ä—ã, –≤—ã–¥–µ–ª–µ–Ω–∏—è)
- –û–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** –≤ `handleJoinProject`
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis** –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–î–æ–±–∞–≤–∏—Ç—å rate limiting** –¥–ª—è WebSocket —Å–æ–±—ã—Ç–∏–π  
4. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**
5. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** 