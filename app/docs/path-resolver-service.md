# Path Resolver Service

## Описание

PathResolverService — это сервис, отвечающий за определение доступных путей из текущего узла во время воспроизведения сценария. Сервис анализирует все исходящие связи, проверяет условия на них, приоритизирует пути и определяет, куда может быть направлен пользователь дальше.

## Архитектура

Архитектура PathResolver построена с учетом принципов SOLID, в частности принципа единственной ответственности (S) и инверсии зависимостей (D). Это обеспечивает гибкость и тестируемость компонента.

### Компоненты

- **PathResolver (интерфейс)** — определяет контракт для сервиса разрешения путей
- **PathResolverResult (интерфейс)** — структура данных, содержащая результаты разрешения путей
- **PathPriority (enum)** — перечисление уровней приоритета для разных типов путей
- **PathResolverService (класс)** — реализация интерфейса PathResolver

### Зависимости

- **ConditionEvaluator** — сервис для оценки условий на связях

## Принцип работы

1. Сервис получает текущий узел, список исходящих связей и текущее состояние игры
2. Проверяет условия на каждой связи с помощью ConditionEvaluator
3. Фильтрует связи, получая только валидные (те, чьи условия выполняются)
4. Категоризирует валидные связи по приоритетам
5. Выбирает путь с наивысшим приоритетом или оставляет выбор пользователю (для выборов)

## Приоритеты путей

Сервис использует следующие приоритеты для путей (от высшего к низшему):

1. **CONDITIONAL_NARRATIVE (1)** — связь с условиями в нарративный узел
   - Если таких связей несколько, выбирается случайно одна из них
   - Высший приоритет, автоматический переход

2. **CHOICE (2)** — связь в узел выбора
   - Если высший приоритет имеют пути к выборам, selectedPath не устанавливается
   - Пользователь сам должен выбрать один из вариантов

3. **DIRECT_NARRATIVE (3)** — прямая связь без условий в нарративный узел
   - Если таких связей несколько, выбирается случайно одна из них
   - Низший приоритет, автоматический переход если нет путей выше

## Особенности реализации

### Случайный выбор для нарративных узлов

Если существует несколько валидных путей с одинаковым приоритетом (например, несколько нарративных узлов с условиями), сервис случайным образом выбирает один из них. Это обеспечивает непредсказуемость и разнообразие игрового опыта.

### Обработка выборов

Важная особенность: если высший приоритет имеют пути, ведущие к узлам выбора, сервис не выбирает конкретный путь автоматически. Вместо этого, он возвращает все валидные пути в поле `prioritizedPaths[PathPriority.CHOICE]`, а поле `selectedPath` остается `undefined`. Это позволяет пользователю самостоятельно выбрать путь.

### Интеграция с системой условий

PathResolver тесно интегрирован с системой условий через ConditionEvaluator. Это позволяет корректно обрабатывать сложные сценарии с различными типами условий:
- Вероятностные условия (probability)
- Условия на основе переменных (variable_comparison)
- Условия посещения узлов (node_happened, node_not_happened)

## Пример использования

```typescript
// Создание зависимостей
const strategyFactory = new ConditionStrategyFactory();
const conditionEvaluator = new ConditionEvaluatorImpl(strategyFactory);
const pathResolver = new PathResolverService(conditionEvaluator);

// Вызов сервиса
const result = pathResolver.resolvePaths(
  currentNode,
  outgoingLinks,
  gameState,
  availableNodes
);

// Использование результата
if (result.selectedPath) {
  // Автоматический переход по выбранному пути
  navigateToNode(result.selectedPath.endNodeId);
} else if (result.prioritizedPaths[PathPriority.CHOICE].length > 0) {
  // Показываем пользователю варианты выбора
  showChoices(result.prioritizedPaths[PathPriority.CHOICE]);
} else {
  // Нет доступных путей
  showEndOfStory();
}
```

## Диаграмма работы

```
                  +----------------+
                  |   Нарративный  |
                  |      узел      |
                  +-------+--------+
                          |
                          v
+----------------+   +--------------+   +----------------+
| Связи с        |   |   Получаем   |   | Фильтруем по   |
| разными        +---> исходящие    +--->   условиям     |
| условиями      |   |    связи     |   |                |
+----------------+   +--------------+   +-------+--------+
                                                |
                                                v
                  +----------------+    +----------------+
                  | Выдаем путь с  |<---+ Сортируем по   |
                  | наивысшим      |    | приоритетам    |
                  | приоритетом    |    |                |
                  +----------------+    +----------------+
```

## Заключение

PathResolverService является ключевым компонентом системы воспроизведения сценариев. Он обеспечивает правильную маршрутизацию между узлами в зависимости от условий и типов узлов. Архитектурно сервис спроектирован как независимый модуль, который легко тестировать и интегрировать в общую систему воспроизведения. 