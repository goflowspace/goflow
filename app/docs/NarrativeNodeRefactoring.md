# Архитектура рефакторинга нарративного узла

## Общая концепция

Рефакторинг нарративного узла основан на принципах DRY/KISS/SOLID с целью улучшения структуры кода, упрощения поддержки и подготовки к будущему тестированию. Основная идея - разделение ответственности между различными компонентами, вынесение логики в отдельные файлы и устранение повторяющегося кода.

## Структура компонентов

Архитектура разделена на следующие основные компоненты:

1. **Константы** (`constants.ts`)
   - Вынесение всех магических чисел и строк в именованные константы
   - Группировка констант по смысловому назначению (стили, размеры, задержки)
   - Предотвращение дублирования значений через единую точку доступа

2. **Утилиты** (`utils.ts`)
   - Чистые функции для работы с DOM и расчетами
   - Функции для обновления соединений узла
   - Утилиты для расчета высоты текстового поля и карточки
   - Вспомогательные функции для работы с текстом

3. **Компоненты отображения** (`NodeContent.tsx`, `NodeHint.tsx`)
   - Маленькие переиспользуемые компоненты с единственной ответственностью
   - Разделение на редактируемые и статические варианты элементов
   - Использование React.forwardRef для передачи ссылок из родительских компонентов

4. **Логика узла** (`useNarrativeNode.ts`)
   - Кастомный хук, инкапсулирующий всю бизнес-логику
   - Управление состоянием (текст, заголовок, режим редактирования)
   - Обработчики событий (клик, клавиатура, потеря фокуса)
   - Адаптеры для взаимодействия с другими компонентами системы

5. **Основной компонент** (`NarrativeNode.tsx`)
   - Только композиция компонентов и отображение
   - Минимум собственной логики
   - Использование хуков для получения данных и обработчиков

## Принципы DRY/KISS/SOLID в реализации

### DRY (Don't Repeat Yourself)
- Утилиты `adjustCardHeight` и `adjustTextAreaHeight` заменяют дублирование кода для изменения размеров
- Компоненты `EditableContent`/`StaticContent` устраняют дублирование логики отображения
- Константы объединены по категориям, исключая повторение значений

### KISS (Keep It Simple, Stupid)
- Каждый компонент решает только одну задачу
- Логика разделена на понятные функции с говорящими именами
- Минимизация сложных условий и вложенных конструкций

### SOLID
- **S** (Single Responsibility): каждый файл отвечает за одну область функциональности
- **O** (Open-Closed): архитектура позволяет легко расширять функционал без изменения существующего кода
- **L** (Liskov Substitution): компоненты с похожим поведением следуют одинаковым интерфейсам
- **I** (Interface Segregation): интерфейсы компонентов минимальны и специфичны для их задач
- **D** (Dependency Inversion): высокоуровневые компоненты не зависят от деталей реализации

## Преимущества новой архитектуры

1. **Улучшенная тестируемость**
   - Логика отделена от отображения, что упрощает юнит-тестирование
   - Чистые функции в utils легко покрываются тестами
   - Компоненты можно тестировать изолированно

2. **Улучшенная поддержка**
   - Локализация изменений: правки затрагивают только соответствующие файлы
   - Понятная структура упрощает поиск нужного кода
   - Константы делают код более читаемым и предсказуемым

3. **Масштабируемость**
   - Легко добавлять новые функции без нарушения существующей логики
   - Компоненты можно переиспользовать в других частях приложения
   - Архитектура поддерживает расширение без роста сложности

## Схема взаимодействия компонентов

```
NarrativeNode.tsx (композиция)
  |
  ├── useNarrativeNode.ts (логика и состояние)
  |     |
  |     ├── utils.ts (вспомогательные функции)
  |     └── constants.ts (конфигурация)
  |
  ├── NodeContent.tsx (UI компоненты)
  |     └── utils.ts (вычисления для отображения)
  |
  ├── NodeHint.tsx (компонент подсказок)
  └── OperationsList.tsx (список операций)
```

Этот подход обеспечивает четкое разделение ответственности, упрощает поддержку кода и создает основу для дальнейшего расширения функциональности нарративного узла.

## Рефакторинг узла выбора (ChoiceNode)

На основе архитектуры нарративного узла был проведен аналогичный рефакторинг узла выбора. Этот рефакторинг демонстрирует переиспользуемость подхода для различных типов узлов.

### Структура компонентов узла выбора

1. **Константы** (`constants.ts`)
   - Параметры внешнего вида (цвета, стили)
   - Конфигурация размеров и высоты узла
   - Тексты подсказок и сообщений

2. **Утилиты** (`utils.ts`)
   - Функции для расчета высоты на основе содержимого
   - Обновление соединений и связей с другими узлами
   - Вспомогательные функции для работы с текстом

3. **Компоненты отображения** (`NodeContent.tsx`, `NodeHint.tsx`)
   - Редактируемое и статическое представление текста
   - Компонент для подсказок пользователю
   - Единая стилизация интерфейса

4. **Логика узла** (`useChoiceNode.ts`)
   - Управление состоянием и размерами узла
   - Обработка изменений текста и высоты
   - Взаимодействие с хранилищем и React Go Flow

5. **Основной компонент** (`ChoiceNode.tsx`)
   - Композиция всех вышеперечисленных элементов
   - Минимум собственной логики
   - Четкое разделение ответственности

### Результаты рефакторинга

Рефакторинг узла выбора привел к:

1. **Унификации подхода** - использование одинаковой архитектуры для разных типов узлов
2. **Улучшению читаемости** - меньше кода в основном компоненте, лучшая структура
3. **Повышению гибкости** - легче вносить изменения и добавлять новую функциональность
4. **Устранению дублирования** - общие паттерны выделены в отдельные компоненты

Успешное применение этой архитектуры для двух различных типов узлов подтверждает её универсальность и эффективность в контексте данного приложения. 