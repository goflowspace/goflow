FROM node:21-alpine AS builder
WORKDIR /app

# Build args –¥–ª—è edition
ARG NEXT_PUBLIC_EDITION=cloud
ARG NEXT_PUBLIC_API_URL=http://localhost:3001
ENV NEXT_PUBLIC_EDITION=${NEXT_PUBLIC_EDITION}
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY package.json package-lock.json ./
RUN npm install --legacy-peer-deps

# –ö–æ–ø–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–µ–∫—Ç
COPY . .

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
RUN npm run build

# -----------------------------

FROM node:21-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

# –ö–æ–ø–∏—Ä—É–µ–º Next standalone-—Å–±–æ—Ä–∫—É
COPY --from=builder /app/.next/standalone ./

# –ö–æ–ø–∏—Ä—É–µ–º static-—Ñ–∞–π–ª—ã
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

# üëá –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: —Ç–≤–æ–π src-–∫–æ–¥ (–Ω—É–∂–µ–Ω, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ runtime, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è aliased –ø—É—Ç–µ–π)
COPY --from=builder /app/src ./src

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã
COPY --from=builder /app/package.json ./
COPY --from=builder /app/next.config.ts ./

EXPOSE 3000
CMD ["node", "server.js"]
