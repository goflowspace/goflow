# PlaybackLogPanelV2

Новая версия панели лога воспроизведения для Go Flow. Панель визуально отображает историю воспроизведения, включая нарративные узлы, выборы игрока, условия и переходы между узлами.

## Основные особенности

- **Визуальное отображение истории**: Показывает путь игрока через историю
- **Поддержка различных типов записей**: Нарративы, выборы, условия, переходы
- **Раскрывающиеся операции**: Операции в нарративных узлах можно раскрыть/скрыть
- **Раскрывающиеся условия**: Условия можно раскрыть для просмотра деталей
- **Управление данными**: Сортировка, раскрытие/скрытие всех записей, очистка лога
- **Дизайн по макету Figma**: Полностью соответствует предоставленному дизайну

## Типы записей

### 1. Нарративный узел (NarrativeLogEntry)

- Отображает посещение нарративного узла
- Может содержать операции, которые изменяют переменные
- Фон: светло-фиолетовый (#F8F8FF)
- Цвет текста: фиолетовый (#5753C6)

### 2. Выбор игрока (ChoiceLogEntry)

- Отображает выбор, сделанный игроком
- Фон: светло-зеленый (#F3FBF9)
- Цвет текста: зеленый (#218358)

### 3. Условия (ConditionLogEntry)

- Отображает сработавшие условия
- Поддерживает три типа условий:
  - Сравнение с пользовательским значением
  - Сравнение переменных
  - Проверка шанса
- Фон: светло-серый (#F9F9F9)
- Цвет текста: серый (#646464)

### 4. Переход (TransitionLogEntry)

- Визуальный индикатор перехода между узлами
- Отображается как стрелка вниз

## Использование

```tsx
import {LogEntry, LogEntryType, PlaybackLogPanelV2} from '@/playback/ui/PlaybackLogPanelV2';

const entries: LogEntry[] = [
  {
    id: '1',
    type: LogEntryType.NARRATIVE,
    index: 1,
    timestamp: '14:12:02',
    nodeName: 'Начало истории',
    operations: [
      {
        id: 'op1',
        variableName: 'Здоровье',
        operator: '+',
        value: 10,
        result: 110
      }
    ]
  },
  {
    id: '2',
    type: LogEntryType.TRANSITION,
    index: 2,
    timestamp: '14:12:03'
  },
  {
    id: '3',
    type: LogEntryType.CHOICE,
    index: 3,
    timestamp: '14:12:05',
    choiceName: 'Пойти в лес'
  }
];

function App() {
  return <PlaybackLogPanelV2 entries={entries} onClear={() => console.log('Clear log')} onToggleSort={() => console.log('Toggle sort')} onToggleExpandAll={() => console.log('Toggle expand all')} />;
}
```

## Структура компонентов

```
PlaybackLogPanelV2/
├── PlaybackLogPanelV2.tsx    # Основной компонент панели
├── types.ts                   # Типы данных
├── styles.module.css          # Стили
├── components/
│   ├── LogEntry.tsx          # Компонент-роутер для записей
│   ├── NarrativeEntry.tsx    # Компонент нарративной записи
│   ├── ChoiceEntry.tsx       # Компонент записи выбора
│   ├── ConditionEntry.tsx    # Компонент записи условий
│   ├── TransitionEntry.tsx   # Компонент записи перехода
│   ├── OperationView.tsx     # Компонент отображения операции
│   └── ConditionView.tsx     # Компонент отображения условия
└── index.ts                  # Экспорты
```

## Принципы разработки

- **DRY (Don't Repeat Yourself)**: Переиспользуемые компоненты для операций и условий
- **KISS (Keep It Simple, Stupid)**: Простая и понятная структура компонентов
- **SOLID**: Каждый компонент отвечает за одну задачу, легко расширяется

## Стилизация

Используется CSS Modules для изоляции стилей. Все стили следуют дизайну из Figma:

- Шрифт: Inter
- Основная ширина панели: 350px
- Радиус скругления: 6px для записей, 3px для кнопок
- Отступы и промежутки согласно макету

## Интеграция с RadixRenderer

Панель интегрирована в RadixRenderer и может быть вызвана через кнопку "Logs v2" в нижней панели управления.

### Адаптер данных

Для совместимости со старой системой логов создан адаптер `convertLogsToV2Format`, который:

- Преобразует логи из формата PlaybackLogEntry в формат LogEntryV2
- Использует карту переменных для отображения имен вместо ID
- Привязывает операции к соответствующим нарративным узлам по nodeId
- Добавляет переходы между выборами и узлами для лучшей визуализации
- Обрабатывает все типы условий (сравнение с константой, сравнение переменных, шанс)

### Использование в RadixRenderer

```tsx
// Компонент автоматически получает данные из контекста логов
const LogPanelV2Wrapper: React.FC<{
  isExpanded: boolean;
  onClose: () => void;
}> = ({isExpanded}) => {
  const logManager = usePlaybackLog();
  const logs = logManager.getLogs();
  const variables = logManager.variables;
  const entriesV2 = React.useMemo(() => convertLogsToV2Format(logs, variables), [logs, variables]);

  return (
    <div className={`playback-panel playback-panel--right ${!isExpanded ? 'playback-panel--collapsed' : ''}`}>
      {isExpanded && <PlaybackLogPanelV2 entries={entriesV2} onClear={() => logManager.clearLog()} />}
    </div>
  );
};
```

### Переключение между версиями

- При открытии новой панели автоматически закрывается старая версия
- При открытии старой панели автоматически закрывается новая версия
- Это предотвращает наложение панелей друг на друга

## Изменения в версии

### Исправлены проблемы:

1. **Корректная нумерация** - переходы (стрелки) больше не имеют индексов и не влияют на нумерацию
2. **Переходы между нарративами** - теперь стрелки отображаются между всеми последовательными нарративными узлами
3. **Отображение условий** - условия теперь корректно отображаются с переходами
4. **Улучшена обработка операций** - добавлена поддержка операции `override` и улучшена обработка значений
5. **Привязка операций к узлам** - операции теперь корректно привязываются к своим узлам по nodeId
6. **Добавлено отладочное логирование** - для диагностики проблем с отображением условий
